// Prisma Schema Draft for Election System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 사용자 및 인증
// ============================================

enum UserRole {
  MEMBER
  ADMIN
  AUDITOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id           String      @id @default(cuid())
  employeeNo   String      @unique
  email        String      @unique
  name         String
  department   String?
  role         UserRole    @default(MEMBER)
  status       UserStatus  @default(ACTIVE)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  recommendations  Recommendation[]
  candidacies      Candidate[]
  votes            Vote[]
  accessLogs       AccessLog[]
  otpTokens        OtpToken[]

  @@index([employeeNo])
  @@index([email])
  @@map("users")
}

model OtpToken {
  id         String    @id @default(cuid())
  userId     String
  token      String    // 해시 저장
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("otp_tokens")
}

// ============================================
// 선거 관리
// ============================================

enum ElectionStatus {
  PLANNING           // 기획 중
  RECOMMEND          // 추천 진행 중
  CANDIDATE_CONFIRM  // 후보 확정 중
  VOTING             // 투표 진행 중
  CLOSED             // 종료
}

model ElectionRound {
  id                    String          @id @default(cuid())
  name                  String
  description           String?
  status                ElectionStatus  @default(PLANNING)
  recommendStartAt      DateTime?
  recommendEndAt        DateTime?
  votingStartAt         DateTime?
  votingEndAt           DateTime?
  resultAnnouncedAt     DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  recommendations       Recommendation[]
  candidates            Candidate[]
  votes                 Vote[]
  transitionDocs        TransitionDoc[]
  notificationLogs      NotificationLog[]

  @@index([status])
  @@index([votingStartAt])
  @@map("election_rounds")
}

// ============================================
// 추천
// ============================================

enum RoleType {
  PRESIDENT  // 회장
  TREASURER  // 총무
}

model Recommendation {
  id                 String         @id @default(cuid())
  electionId         String
  recommenderId      String
  forRole            RoleType
  candidateName      String         // 추천 대상 이름
  candidateUserId    String?        // 시스템 사용자인 경우
  reason             String?
  createdAt          DateTime       @default(now())

  election           ElectionRound  @relation(fields: [electionId], references: [id], onDelete: Cascade)
  recommender        User           @relation(fields: [recommenderId], references: [id], onDelete: Cascade)

  @@unique([electionId, recommenderId, forRole])
  @@index([electionId])
  @@index([forRole])
  @@map("recommendations")
}

// ============================================
// 후보
// ============================================

enum CandidateStatus {
  INVITED   // 초대됨
  ACCEPTED  // 수락
  DECLINED  // 거절
}

model Candidate {
  id              String           @id @default(cuid())
  electionId      String
  userId          String
  forRole         RoleType
  status          CandidateStatus  @default(INVITED)
  biography       String?          // 약력/공약
  invitedAt       DateTime         @default(now())
  respondedAt     DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  election        ElectionRound    @relation(fields: [electionId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes           Vote[]

  @@unique([electionId, userId, forRole])
  @@index([electionId])
  @@index([status])
  @@map("candidates")
}

// ============================================
// 투표
// ============================================

model Vote {
  id            String         @id @default(cuid())
  electionId    String
  voterId       String
  candidateId   String
  forRole       RoleType
  ballotHash    String         // 무결성 검증용 해시
  createdAt     DateTime       @default(now())

  election      ElectionRound  @relation(fields: [electionId], references: [id], onDelete: Cascade)
  voter         User           @relation(fields: [voterId], references: [id], onDelete: Cascade)
  candidate     Candidate      @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([electionId, voterId, forRole])
  @@index([electionId])
  @@index([candidateId])
  @@map("votes")
}

// ============================================
// 알림
// ============================================

enum NotificationType {
  RECOMMEND_START
  RECOMMEND_END
  CANDIDATE_ANNOUNCE
  CANDIDATE_INVITE
  VOTING_START
  VOTING_END
  RESULT_ANNOUNCE
}

enum NotificationChannel {
  EMAIL
  KAKAO_WORK
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

model NotificationLog {
  id          String               @id @default(cuid())
  electionId  String?
  type        NotificationType
  channel     NotificationChannel
  recipient   String               // 이메일 또는 ID
  subject     String?
  body        String
  status      NotificationStatus   @default(PENDING)
  sentAt      DateTime?
  error       String?
  createdAt   DateTime             @default(now())

  election    ElectionRound?       @relation(fields: [electionId], references: [id], onDelete: SetNull)

  @@index([electionId])
  @@index([status])
  @@index([createdAt])
  @@map("notification_logs")
}

// ============================================
// 이양 관리
// ============================================

enum TransitionStatus {
  TODO
  IN_PROGRESS
  DONE
}

model TransitionDoc {
  id            String            @id @default(cuid())
  electionId    String
  title         String
  description   String?
  fileUrl       String?           // S3 or NAS path
  status        TransitionStatus  @default(TODO)
  uploadedBy    String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  election      ElectionRound     @relation(fields: [electionId], references: [id], onDelete: Cascade)

  @@index([electionId])
  @@map("transition_docs")
}

// ============================================
// 감사 로그
// ============================================

enum ActionType {
  LOGIN
  LOGOUT
  RECOMMEND_SUBMIT
  VOTE_SUBMIT
  ELECTION_CREATE
  ELECTION_STATUS_CHANGE
  CANDIDATE_INVITE
  CANDIDATE_RESPOND
  RESULT_ANNOUNCE
}

model AccessLog {
  id          String      @id @default(cuid())
  userId      String?
  action      ActionType
  resource    String?     // electionId, candidateId 등
  ipAddress   String?
  userAgent   String?
  details     Json?       // 추가 정보
  createdAt   DateTime    @default(now())

  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("access_logs")
}
