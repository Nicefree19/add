<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ìš°íšŒ íšŒë¹„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
        }

        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 112, 192, 0.1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .table-header {
            background: linear-gradient(135deg, #0070C0 0%, #0056a3 100%);
        }

        .income-text {
            color: #10b981;
        }

        .expense-text {
            color: #ef4444;
        }

        .transfer-text {
            color: #f59e0b;
        }

        .pagination-btn {
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background-color: #0070C0;
            color: white;
        }

        .pagination-btn.active {
            background-color: #0070C0;
            color: white;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .search-input:focus {
            border-color: #0070C0;
            ring-color: #0070C0;
        }

        .filter-btn.active {
            background-color: #0070C0;
            color: white;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #0070C0;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ğŸ’¼ ì‚¬ìš°íšŒ íšŒë¹„ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
                    <p class="text-blue-100 mt-2">ì‹¤ì‹œê°„ ì¬ë¬´ í˜„í™© ë° ê±°ë˜ ë‚´ì—­</p>
                </div>
                <div>
                    <a href="excel_loader.html" class="bg-white text-blue-600 hover:bg-blue-50 font-semibold py-2 px-4 rounded-lg shadow transition">
                        ğŸ“Š ì—‘ì…€ ì—…ë¡œë“œ
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- ê³„ì¢Œ ì”ì•¡ ì¹´ë“œ -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ’° í˜„ì¬ ì”ì•¡ <span class="text-sm text-gray-500 font-normal">(2025ë…„ 11ì›” 11ì¼ ê¸°ì¤€)</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì¹´ì¹´ì˜¤ë±…í¬ í†µì¥</p>
                            <p class="text-2xl font-bold text-gray-800 mt-2" id="kakao-balance">â‚©0</p>
                            <p class="text-xs text-gray-500 mt-1" id="kakao-account">-</p>
                        </div>
                        <div class="stat-icon bg-yellow-100">
                            <span>ğŸ¦</span>
                        </div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì„¸ì´í”„ë°•ìŠ¤</p>
                            <p class="text-2xl font-bold text-green-600 mt-2" id="safebox-balance">â‚©0</p>
                            <p class="text-xs text-gray-500 mt-1" id="safebox-desc">-</p>
                        </div>
                        <div class="stat-icon bg-green-100">
                            <span>ğŸ”’</span>
                        </div>
                    </div>
                    <a href="safebox.html" class="text-xs text-blue-600 hover:underline mt-2 inline-block">ì„¸ì´í”„ë°•ìŠ¤ ìƒì„¸ ë³´ê¸° â†’</a>
                </div>

                <div class="card bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl shadow-lg p-6 border-l-4 border-purple-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm font-medium">ğŸ’ ì´ ìš´ìš©ì•¡</p>
                            <p class="text-3xl font-bold mt-2" id="total-balance">â‚©0</p>
                            <p class="text-xs text-purple-200 mt-1">ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥ ê¸ˆì•¡</p>
                        </div>
                        <div class="stat-icon bg-purple-400">
                            <span>ğŸ’°</span>
                        </div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6 border-l-4 border-gray-400 opacity-75">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì‹ í•œì€í–‰ (íì‡„)</p>
                            <p class="text-2xl font-bold text-gray-400 mt-2">â‚©0</p>
                            <p class="text-xs text-gray-400 mt-1">2020ë…„ 12ì›” ì´í›„ ë¯¸ì‚¬ìš©</p>
                        </div>
                        <div class="stat-icon bg-gray-100">
                            <span>ğŸ¦</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ì£¼ìš” í†µê³„ ì¹´ë“œ -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“Š ì£¼ìš” í†µê³„</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì´ ì…ê¸ˆ</p>
                            <p class="text-2xl font-bold income-text mt-2" id="total-income">â‚©0</p>
                        </div>
                        <div class="stat-icon bg-green-100 text-green-600">
                            <span>ğŸ“ˆ</span>
                        </div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì´ ì¶œê¸ˆ</p>
                            <p class="text-2xl font-bold expense-text mt-2" id="total-expense">â‚©0</p>
                        </div>
                        <div class="stat-icon bg-red-100 text-red-600">
                            <span>ğŸ“‰</span>
                        </div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì´ì ìˆ˜ìµ</p>
                            <p class="text-2xl font-bold text-blue-600 mt-2" id="total-interest">â‚©0</p>
                        </div>
                        <div class="stat-icon bg-blue-100 text-blue-600">
                            <span>ğŸ’µ</span>
                        </div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì´ ê±°ë˜ ê±´ìˆ˜</p>
                            <p class="text-2xl font-bold text-gray-800 mt-2" id="total-transactions">0</p>
                        </div>
                        <div class="stat-icon bg-gray-100 text-gray-600">
                            <span>ğŸ”¢</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ˆ ì¬ë¬´ ë¶„ì„</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="card bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ì—°ë„ë³„ ìˆ˜ì…/ì§€ì¶œ</h3>
                    <canvas id="yearlyChart"></canvas>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ìˆ˜ì…/ì§€ì¶œ ë¹„ìœ¨</h3>
                    <canvas id="ratioChart"></canvas>
                </div>
            </div>

            <div class="card bg-white rounded-xl shadow-md p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ì›”ë³„ ì¶”ì´ (2025ë…„)</h3>
                <canvas id="monthlyChart"></canvas>
            </div>
        </section>

        <!-- ê±°ë˜ ë‚´ì—­ í…Œì´ë¸” -->
        <section class="mb-8">
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“‹ ê±°ë˜ ë‚´ì—­</h2>

                    <!-- ê²€ìƒ‰ ë° í•„í„° -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="col-span-1 md:col-span-2">
                            <input
                                type="text"
                                id="search-input"
                                placeholder="ê²€ìƒ‰ (ì„¤ëª…, ì¹´í…Œê³ ë¦¬...)"
                                class="search-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2"
                            />
                        </div>

                        <div>
                            <select id="bank-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">ëª¨ë“  ì€í–‰</option>
                                <option value="kakao_bank">ì¹´ì¹´ì˜¤ë±…í¬</option>
                                <option value="shinhan_bank">ì‹ í•œì€í–‰</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between px-4 py-2 border border-gray-300 rounded-lg">
                            <label for="safebox-toggle" class="text-sm font-medium text-gray-700">ì„¸ì´í”„ë°•ìŠ¤ í¬í•¨</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="safebox-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- íƒ€ì… í•„í„° ë²„íŠ¼ -->
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button class="filter-btn active px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition" data-type="all">
                            ì „ì²´
                        </button>
                        <button class="filter-btn px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition" data-type="income">
                            <span class="income-text">ğŸ“ˆ ì…ê¸ˆ</span>
                        </button>
                        <button class="filter-btn px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition" data-type="expense">
                            <span class="expense-text">ğŸ“‰ ì¶œê¸ˆ</span>
                        </button>
                        <button class="filter-btn px-4 py-2 rounded-lg border border-gray-300 text-sm font-medium transition" data-type="transfer">
                            <span class="transfer-text">ğŸ”„ ì´ì²´</span>
                        </button>
                    </div>
                </div>

                <!-- í…Œì´ë¸” -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="table-header text-white">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold cursor-pointer hover:bg-blue-700" onclick="sortTable('date')">
                                    ë‚ ì§œ <span id="sort-date">â†•ï¸</span>
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-semibold cursor-pointer hover:bg-blue-700" onclick="sortTable('type')">
                                    ìœ í˜• <span id="sort-type">â†•ï¸</span>
                                </th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">ì¹´í…Œê³ ë¦¬</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">ì„¤ëª…</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold">ì€í–‰</th>
                                <th class="px-6 py-4 text-right text-sm font-semibold cursor-pointer hover:bg-blue-700" onclick="sortTable('amount')">
                                    ê¸ˆì•¡ <span id="sort-amount">â†•ï¸</span>
                                </th>
                                <th class="px-6 py-4 text-right text-sm font-semibold">ì”ì•¡</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table">
                            <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="p-6 border-t border-gray-200 flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        <span id="showing-info">-</span>
                    </div>
                    <div class="flex gap-2" id="pagination">
                        <!-- í˜ì´ì§€ ë²„íŠ¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">Â© 2025 ì‚¬ìš°íšŒ íšŒë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            <p class="text-gray-500 text-sm mt-2">ë°ì´í„° ì—…ë°ì´íŠ¸: <span id="last-update">-</span></p>
        </div>
    </footer>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let dashboardData = null;
        let filteredTransactions = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentSort = { field: 'date', direction: 'desc' };
        let currentFilters = {
            search: '',
            bank: 'all',
            type: 'all',
            includeSafeBox: true
        };

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                // 1. ë¨¼ì € localStorageì—ì„œ ë°ì´í„° í™•ì¸
                const savedData = localStorage.getItem('dashboard_data');
                if (savedData) {
                    console.log('localStorageì—ì„œ ë°ì´í„° ë¡œë“œ');
                    dashboardData = JSON.parse(savedData);
                    initializeDashboard();
                    return;
                }

                // 2. localStorageì— ì—†ìœ¼ë©´ JSON íŒŒì¼ì—ì„œ ë¡œë“œ
                console.log('JSON íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ');
                const response = await fetch('dashboard_data.json');
                dashboardData = await response.json();
                initializeDashboard();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showDataLoadError();
            }
        }

        // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë©”ì‹œì§€ í‘œì‹œ
        function showDataLoadError() {
            const main = document.querySelector('main');
            main.innerHTML = `
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg shadow-md">
                    <div class="flex items-center mb-4">
                        <svg class="h-8 w-8 text-yellow-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <h2 class="text-2xl font-bold text-yellow-800">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                    </div>
                    <p class="text-yellow-700 mb-4">ëŒ€ì‹œë³´ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                    <a href="excel_loader.html" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                        ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œí•˜ê¸° â†’
                    </a>
                </div>
            `;
        }

        // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
        function initializeDashboard() {
            updateBalanceCards();
            updateStatisticsCards();
            updateCharts();
            filterAndDisplayTransactions();
            updateLastUpdate();
        }

        // ê¸ˆì•¡ í¬ë§·íŒ… (ì‰¼í‘œ ì¶”ê°€)
        function formatCurrency(amount) {
            return 'â‚©' + amount.toLocaleString('ko-KR');
        }

        // ë‚ ì§œ í¬ë§·íŒ…
        function formatDate(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}ë…„ ${month}ì›” ${day}ì¼`;
        }

        // ì”ì•¡ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateBalanceCards() {
            const { accounts, summary } = dashboardData;

            document.getElementById('kakao-balance').textContent = formatCurrency(summary.kakao_balance);
            document.getElementById('kakao-account').textContent = accounts.kakao_bank.account_number;

            document.getElementById('safebox-balance').textContent = formatCurrency(summary.safebox_balance);
            document.getElementById('safebox-desc').textContent = accounts.safe_box.description;

            document.getElementById('total-balance').textContent = formatCurrency(summary.total_balance);
        }

        // í†µê³„ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateStatisticsCards() {
            const { summary } = dashboardData;

            document.getElementById('total-income').textContent = formatCurrency(summary.total_income);
            document.getElementById('total-expense').textContent = formatCurrency(summary.total_expense);
            document.getElementById('total-interest').textContent = formatCurrency(summary.total_interest);
            document.getElementById('total-transactions').textContent = summary.total_transactions + 'ê±´';
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts() {
            createYearlyChart();
            createRatioChart();
            createMonthlyChart();
        }

        // ì—°ë„ë³„ ì°¨íŠ¸
        function createYearlyChart() {
            const { transactions } = dashboardData;
            const yearlyData = {};

            transactions.forEach(t => {
                const year = new Date(t.date).getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = { income: 0, expense: 0 };
                }

                if (t.type === 'income' && t.category !== 'ì´ì') {
                    yearlyData[year].income += t.amount;
                } else if (t.type === 'expense') {
                    yearlyData[year].expense += t.amount;
                }
            });

            const years = Object.keys(yearlyData).sort();
            const incomeData = years.map(y => yearlyData[y].income);
            const expenseData = years.map(y => yearlyData[y].expense);

            const ctx = document.getElementById('yearlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'ìˆ˜ì…',
                            data: incomeData,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgb(16, 185, 129)',
                            borderWidth: 2
                        },
                        {
                            label: 'ì§€ì¶œ',
                            data: expenseData,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚©' + (value / 1000000) + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ìˆ˜ì…/ì§€ì¶œ ë¹„ìœ¨ ì°¨íŠ¸
        function createRatioChart() {
            const { summary } = dashboardData;

            const ctx = document.getElementById('ratioChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ìˆ˜ì…', 'ì§€ì¶œ'],
                    datasets: [{
                        data: [summary.total_income, summary.total_expense],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.7)',
                            'rgba(239, 68, 68, 0.7)'
                        ],
                        borderColor: [
                            'rgb(16, 185, 129)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = summary.total_income + summary.total_expense;
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + formatCurrency(context.parsed) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ì›”ë³„ ì¶”ì´ ì°¨íŠ¸
        function createMonthlyChart() {
            const { transactions } = dashboardData;
            const monthlyData = {};

            // 2025ë…„ ë°ì´í„°ë§Œ í•„í„°ë§
            transactions.filter(t => new Date(t.date).getFullYear() === 2025).forEach(t => {
                const month = new Date(t.date).getMonth() + 1;
                if (!monthlyData[month]) {
                    monthlyData[month] = { income: 0, expense: 0 };
                }

                if (t.type === 'income') {
                    monthlyData[month].income += t.amount;
                } else if (t.type === 'expense') {
                    monthlyData[month].expense += t.amount;
                }
            });

            const months = Array.from({length: 12}, (_, i) => i + 1);
            const monthLabels = months.map(m => m + 'ì›”');
            const incomeData = months.map(m => monthlyData[m]?.income || 0);
            const expenseData = months.map(m => monthlyData[m]?.expense || 0);

            const ctx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [
                        {
                            label: 'ìˆ˜ì…',
                            data: incomeData,
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: 'rgb(16, 185, 129)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'ì§€ì¶œ',
                            data: expenseData,
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderColor: 'rgb(239, 68, 68)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚©' + (value / 1000000) + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        // ê±°ë˜ í•„í„°ë§ ë° í‘œì‹œ
        function filterAndDisplayTransactions() {
            const { transactions } = dashboardData;

            // í•„í„° ì ìš©
            filteredTransactions = transactions.filter(t => {
                // ì„¸ì´í”„ë°•ìŠ¤ í•„í„°
                if (!currentFilters.includeSafeBox && t.is_safe_box) {
                    return false;
                }

                // ì€í–‰ í•„í„°
                if (currentFilters.bank !== 'all' && t.bank !== currentFilters.bank) {
                    return false;
                }

                // íƒ€ì… í•„í„°
                if (currentFilters.type !== 'all' && t.type !== currentFilters.type) {
                    return false;
                }

                // ê²€ìƒ‰ í•„í„°
                if (currentFilters.search) {
                    const searchLower = currentFilters.search.toLowerCase();
                    return (
                        t.description.toLowerCase().includes(searchLower) ||
                        t.category.toLowerCase().includes(searchLower)
                    );
                }

                return true;
            });

            // ì •ë ¬ ì ìš©
            sortTransactions();

            // í˜ì´ì§€ ë¦¬ì…‹
            currentPage = 1;

            // í…Œì´ë¸” ë Œë”ë§
            renderTransactionsTable();
            renderPagination();
        }

        // ê±°ë˜ ì •ë ¬
        function sortTransactions() {
            filteredTransactions.sort((a, b) => {
                let aVal, bVal;

                switch(currentSort.field) {
                    case 'date':
                        aVal = new Date(a.date);
                        bVal = new Date(b.date);
                        break;
                    case 'amount':
                        aVal = a.amount;
                        bVal = b.amount;
                        break;
                    case 'type':
                        aVal = a.type;
                        bVal = b.type;
                        break;
                    default:
                        return 0;
                }

                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTransactionsTable() {
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageTransactions = filteredTransactions.slice(startIdx, endIdx);

            const tbody = document.getElementById('transactions-table');
            tbody.innerHTML = '';

            if (pageTransactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                        </td>
                    </tr>
                `;
                document.getElementById('showing-info').textContent = 'ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ';
                return;
            }

            pageTransactions.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-200 hover:bg-gray-50 transition';

                // íƒ€ì… í‘œì‹œ
                let typeDisplay = '';
                let typeClass = '';
                switch(t.type) {
                    case 'income':
                        typeDisplay = 'ğŸ“ˆ ì…ê¸ˆ';
                        typeClass = 'income-text';
                        break;
                    case 'expense':
                        typeDisplay = 'ğŸ“‰ ì¶œê¸ˆ';
                        typeClass = 'expense-text';
                        break;
                    case 'transfer':
                        typeDisplay = 'ğŸ”„ ì´ì²´';
                        typeClass = 'transfer-text';
                        break;
                }

                // ì€í–‰ í‘œì‹œ
                let bankDisplay = '';
                switch(t.bank) {
                    case 'kakao_bank':
                        bankDisplay = 'ì¹´ì¹´ì˜¤ë±…í¬';
                        break;
                    case 'shinhan_bank':
                        bankDisplay = 'ì‹ í•œì€í–‰';
                        break;
                    default:
                        bankDisplay = t.bank;
                }

                // ê¸ˆì•¡ í‘œì‹œ (ì…ê¸ˆì€ +, ì¶œê¸ˆì€ -)
                const amountPrefix = t.type === 'income' ? '+' : t.type === 'expense' ? '-' : '';
                const amountClass = t.type === 'income' ? 'income-text' : t.type === 'expense' ? 'expense-text' : 'transfer-text';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900">${formatDate(t.date)}</td>
                    <td class="px-6 py-4 text-sm font-medium ${typeClass}">${typeDisplay}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${t.category}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${t.description}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${bankDisplay}</td>
                    <td class="px-6 py-4 text-sm font-semibold ${amountClass} text-right">${amountPrefix}${formatCurrency(t.amount)}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 text-right">${formatCurrency(t.balance_after)}</td>
                `;

                tbody.appendChild(tr);
            });

            // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
            const total = filteredTransactions.length;
            document.getElementById('showing-info').textContent =
                `${startIdx + 1}-${Math.min(endIdx, total)} / ì´ ${total}ê±´`;
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
        function renderPagination() {
            const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // ì´ì „ ë²„íŠ¼
            const prevBtn = createPaginationButton('ì´ì „', currentPage > 1, () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTransactionsTable();
                    renderPagination();
                }
            });
            pagination.appendChild(prevBtn);

            // í˜ì´ì§€ ë²ˆí˜¸
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPaginationButton(i, true, () => {
                    currentPage = i;
                    renderTransactionsTable();
                    renderPagination();
                }, i === currentPage);
                pagination.appendChild(pageBtn);
            }

            // ë‹¤ìŒ ë²„íŠ¼
            const nextBtn = createPaginationButton('ë‹¤ìŒ', currentPage < totalPages, () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTransactionsTable();
                    renderPagination();
                }
            });
            pagination.appendChild(nextBtn);
        }

        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ìƒì„±
        function createPaginationButton(text, enabled, onClick, isActive = false) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = `pagination-btn px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium ${isActive ? 'active' : ''}`;
            btn.disabled = !enabled;
            btn.onclick = onClick;
            return btn;
        }

        // í…Œì´ë¸” ì •ë ¬
        function sortTable(field) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }

            // ì •ë ¬ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            document.querySelectorAll('[id^="sort-"]').forEach(el => {
                el.textContent = 'â†•ï¸';
            });

            const icon = currentSort.direction === 'asc' ? 'â†‘' : 'â†“';
            document.getElementById(`sort-${field}`).textContent = icon;

            filterAndDisplayTransactions();
        }

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        function updateLastUpdate() {
            const now = new Date();
            const formatted = `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ${now.getDate()}ì¼ ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            document.getElementById('last-update').textContent = formatted;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', () => {
            // ë°ì´í„° ë¡œë“œ
            loadData();

            // ê²€ìƒ‰ ì…ë ¥
            document.getElementById('search-input').addEventListener('input', (e) => {
                currentFilters.search = e.target.value;
                filterAndDisplayTransactions();
            });

            // ì€í–‰ í•„í„°
            document.getElementById('bank-filter').addEventListener('change', (e) => {
                currentFilters.bank = e.target.value;
                filterAndDisplayTransactions();
            });

            // ì„¸ì´í”„ë°•ìŠ¤ í† ê¸€
            document.getElementById('safebox-toggle').addEventListener('change', (e) => {
                currentFilters.includeSafeBox = e.target.checked;
                filterAndDisplayTransactions();
            });

            // íƒ€ì… í•„í„° ë²„íŠ¼
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilters.type = btn.dataset.type;
                    filterAndDisplayTransactions();
                });
            });
        });
    </script>
</body>
</html>
