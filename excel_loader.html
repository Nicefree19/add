<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—‘ì…€ ë°ì´í„° ë¡œë” - ì‚¬ìš°íšŒ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .drop-zone {
            border: 3px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            border-color: #0070C0;
            background-color: #ebf8ff;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">ğŸ“Š ì—‘ì…€ ë°ì´í„° ë¡œë”</h1>
            <p class="text-blue-100 mt-2">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ìƒì„±í•˜ì„¸ìš”</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ -->
        <section class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2>
            <p class="text-gray-600 mb-6">ì‚¬ìš°íšŒ íšŒë¹„ ê²°ì‚° ë³´ê³ ì„œ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>

            <div class="drop-zone mb-6 p-12 rounded-xl text-center cursor-pointer" id="dropZone">
                <div class="text-6xl mb-4">ğŸ“„</div>
                <p class="text-lg text-gray-700 font-medium mb-2">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                <p class="text-sm text-gray-500">ì§€ì› í˜•ì‹: .xlsx, .xls</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden">
            </div>

            <div id="loadingIndicator" class="hidden">
                <div class="flex items-center justify-center space-x-2 text-blue-600">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="text-lg font-medium">ì²˜ë¦¬ ì¤‘...</span>
                </div>
            </div>

            <div id="result" class="hidden">
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-green-700 font-medium" id="resultMessage"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="error" class="hidden">
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700 font-medium" id="errorMessage"></p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- í†µê³„ í‘œì‹œ -->
        <section id="stats" class="hidden bg-white rounded-xl shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ˆ ì²˜ë¦¬ ê²°ê³¼</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">ì´ ê±°ë˜ ê±´ìˆ˜</p>
                    <p class="text-2xl font-bold text-blue-600" id="totalTransactions">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">ì´ ì…ê¸ˆ</p>
                    <p class="text-2xl font-bold text-green-600" id="totalIncome">â‚©0</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">ì´ ì¶œê¸ˆ</p>
                    <p class="text-2xl font-bold text-red-600" id="totalExpense">â‚©0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">í˜„ì¬ ì”ì•¡</p>
                    <p class="text-2xl font-bold text-purple-600" id="totalBalance">â‚©0</p>
                </div>
            </div>
        </section>

        <!-- ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ ë²„íŠ¼ -->
        <div class="text-center">
            <a href="index.html" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition">
                ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ â†’
            </a>
        </div>
    </main>

    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const result = document.getElementById('result');
        const error = document.getElementById('error');
        const stats = document.getElementById('stats');

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
        function handleFile(file) {
            // UI ì´ˆê¸°í™”
            loadingIndicator.classList.remove('hidden');
            result.classList.add('hidden');
            error.classList.add('hidden');
            stats.classList.add('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // ë°ì´í„° ì²˜ë¦¬
                    const dashboardData = processExcelData(workbook);

                    // dashboard_data.jsonìœ¼ë¡œ ì €ì¥ (localStorage ì‚¬ìš©)
                    localStorage.setItem('dashboard_data', JSON.stringify(dashboardData));

                    // ê²°ê³¼ í‘œì‹œ
                    showResult(dashboardData);

                } catch (err) {
                    showError('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            };

            reader.onerror = function() {
                showError('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                loadingIndicator.classList.add('hidden');
            };

            reader.readAsArrayBuffer(file);
        }

        // ì—‘ì…€ ë°ì´í„° ì²˜ë¦¬
        function processExcelData(workbook) {
            const transactions = [];

            // ì „ì²´ ê±°ë˜ ë‚´ì—­ ì‹œíŠ¸ ì²˜ë¦¬
            if (workbook.SheetNames.includes('ì „ì²´ ê±°ë˜ ë‚´ì—­')) {
                const sheet = workbook.Sheets['ì „ì²´ ê±°ë˜ ë‚´ì—­'];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                // í—¤ë” ì°¾ê¸° (ê±°ë˜ì¼ì‹œê°€ í¬í•¨ëœ í–‰)
                let headerIndex = -1;
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i][0] === 'ê±°ë˜ì¼ì‹œ') {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex >= 0) {
                    const headers = rows[headerIndex];
                    for (let i = headerIndex + 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row[0]) continue; // ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸°

                        const trans = {
                            date: parseDate(row[0]),
                            type: row[1] && row[1].includes('ì…ê¸ˆ') ? 'income' : 'expense',
                            amount: Math.abs(cleanNumber(row[2])),
                            description: String(row[3] || ''),
                            bank: row[4] && row[4].includes('ì‹ í•œ') ? 'shinhan_bank' : 'kakao_bank',
                            is_safe_box: false,
                            category: determineCategory(row[3], row[1]),
                            balance_after: 0
                        };

                        // ì·¨ì†Œ ê±°ë˜ ì²˜ë¦¬
                        if (row[1] && row[1].includes('ì·¨ì†Œ')) {
                            trans.type = row[1].includes('ì…ê¸ˆ') ? 'expense' : 'income';
                        }

                        transactions.push(trans);
                    }
                }
            }

            // ì„¸ì´í”„ë°•ìŠ¤ ê±°ë˜ë‚´ì—­ ì‹œíŠ¸ ì²˜ë¦¬
            if (workbook.SheetNames.includes('ì„¸ì´í”„ë°•ìŠ¤ ê±°ë˜ë‚´ì—­')) {
                const sheet = workbook.Sheets['ì„¸ì´í”„ë°•ìŠ¤ ê±°ë˜ë‚´ì—­'];
                const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                let headerIndex = -1;
                for (let i = 0; i < rows.length; i++) {
                    if (rows[i][0] === 'ê±°ë˜ì¼ì‹œ') {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex >= 0) {
                    for (let i = headerIndex + 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row[0]) continue;

                        const trans = {
                            date: parseDate(row[0]),
                            type: row[1] && row[1].includes('ì…ê¸ˆ') ? 'income' : 'expense',
                            amount: Math.abs(cleanNumber(row[2])),
                            description: 'ì„¸ì´í”„ë°•ìŠ¤',
                            bank: 'kakao_bank',
                            is_safe_box: true,
                            category: 'ì„¸ì´í”„ë°•ìŠ¤',
                            balance_after: 0
                        };

                        if (row[1] && row[1].includes('ì·¨ì†Œ')) {
                            trans.type = row[1].includes('ì…ê¸ˆ') ? 'expense' : 'income';
                        }

                        transactions.push(trans);
                    }
                }
            }

            // ë‚ ì§œìˆœ ì •ë ¬
            transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

            // ì”ì•¡ ê³„ì‚°
            let balance = 0;
            let safeboxBalance = 0;

            transactions.forEach(trans => {
                if (trans.is_safe_box) {
                    if (trans.type === 'income') {
                        safeboxBalance += trans.amount;
                    } else {
                        safeboxBalance -= trans.amount;
                    }
                    trans.balance_after = safeboxBalance;
                } else {
                    if (trans.type === 'income') {
                        balance += trans.amount;
                    } else {
                        balance -= trans.amount;
                    }
                    trans.balance_after = balance;
                }
            });

            // ìš”ì•½ ê³„ì‚°
            const summary = calculateSummary(transactions);

            return {
                accounts: {
                    kakao_bank: {
                        account_number: '3333-28-1790885',
                        description: 'ì¹´ì¹´ì˜¤ë±…í¬ ì €ì¶•ì˜ˆê¸ˆ',
                        balance: summary.kakao_balance
                    },
                    safe_box: {
                        description: 'ì•ˆì „ ìì‚° ìš´ìš©',
                        balance: summary.safebox_balance
                    },
                    shinhan_bank: {
                        account_number: '110-502-876387',
                        description: 'ì‹ í•œì€í–‰ (íì‡„)',
                        balance: 0,
                        is_closed: true
                    }
                },
                summary: summary,
                transactions: transactions,
                last_updated: new Date().toISOString()
            };
        }

        // ë‚ ì§œ íŒŒì‹±
        function parseDate(dateValue) {
            if (!dateValue) return null;

            // ì—‘ì…€ ë‚ ì§œ ìˆ«ìì¸ ê²½ìš°
            if (typeof dateValue === 'number') {
                const date = XLSX.SSF.parse_date_code(dateValue);
                return `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
            }

            // ë¬¸ìì—´ì¸ ê²½ìš°
            const str = String(dateValue);
            const match = str.match(/(\d{4})[-.\s]?(\d{1,2})[-.\s]?(\d{1,2})/);
            if (match) {
                return `${match[1]}-${String(match[2]).padStart(2, '0')}-${String(match[3]).padStart(2, '0')}`;
            }

            return str;
        }

        // ìˆ«ì ì •ë¦¬
        function cleanNumber(value) {
            if (typeof value === 'number') return value;
            if (!value) return 0;
            const str = String(value).replace(/[^0-9.-]/g, '');
            return parseFloat(str) || 0;
        }

        // ì¹´í…Œê³ ë¦¬ ê²°ì •
        function determineCategory(description, type) {
            const desc = String(description || '').toLowerCase();

            if (desc.includes('ì´ì')) return 'ì´ì';
            if (desc.includes('ì„¸ì´í”„ë°•ìŠ¤')) return 'ì„¸ì´í”„ë°•ìŠ¤';
            if (desc.includes('íšŒë¹„') || desc.includes('ë‚©ë¶€')) return 'íšŒë¹„ ë‚©ë¶€';
            if (desc.includes('atm')) return 'ATM ì¶œê¸ˆ';
            if (desc.includes('ì´ì²´')) return type && type.includes('ì…ê¸ˆ') ? 'ì´ì²´ ì…ê¸ˆ' : 'ì¼ë°˜ ì´ì²´';
            if (desc.includes('ì†¡ê¸ˆ')) return 'ì†¡ê¸ˆ';

            return type && type.includes('ì…ê¸ˆ') ? 'ê¸°íƒ€ ì…ê¸ˆ' : 'ê¸°íƒ€ ì¶œê¸ˆ';
        }

        // ìš”ì•½ í†µê³„ ê³„ì‚°
        function calculateSummary(transactions) {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalInterest = 0;
            let kakaoBalance = 0;
            let safeboxBalance = 0;

            transactions.forEach(trans => {
                if (trans.is_safe_box) {
                    if (trans.type === 'income') {
                        safeboxBalance += trans.amount;
                    } else {
                        safeboxBalance -= trans.amount;
                    }
                } else {
                    if (trans.type === 'income') {
                        totalIncome += trans.amount;
                        if (trans.category === 'ì´ì') {
                            totalInterest += trans.amount;
                        }
                        kakaoBalance += trans.amount;
                    } else {
                        totalExpense += trans.amount;
                        kakaoBalance -= trans.amount;
                    }
                }
            });

            return {
                total_income: totalIncome,
                total_expense: totalExpense,
                total_interest: totalInterest,
                kakao_balance: kakaoBalance,
                safebox_balance: safeboxBalance,
                total_balance: kakaoBalance + safeboxBalance,
                total_transactions: transactions.length
            };
        }

        // ê²°ê³¼ í‘œì‹œ
        function showResult(data) {
            result.classList.remove('hidden');
            stats.classList.remove('hidden');

            document.getElementById('resultMessage').textContent =
                `ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤! (${data.transactions.length}ê±´ì˜ ê±°ë˜)`;

            document.getElementById('totalTransactions').textContent = data.summary.total_transactions + 'ê±´';
            document.getElementById('totalIncome').textContent = formatCurrency(data.summary.total_income);
            document.getElementById('totalExpense').textContent = formatCurrency(data.summary.total_expense);
            document.getElementById('totalBalance').textContent = formatCurrency(data.summary.total_balance);
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            error.classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // ê¸ˆì•¡ í¬ë§·
        function formatCurrency(amount) {
            return 'â‚©' + amount.toLocaleString('ko-KR');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ë°ì´í„° í™•ì¸
        window.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem('dashboard_data');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    showResult(data);
                } catch (e) {
                    console.error('ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', e);
                }
            }
        });
    </script>
</body>
</html>
