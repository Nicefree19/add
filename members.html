<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì› ê´€ë¦¬ - ì‚¬ìš°íšŒ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Noto+Sans KR', sans-serif;
        }

        .card {
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 112, 192, 0.15);
        }

        .member-card {
            border-left: 4px solid #0070C0;
        }

        .member-card.inactive {
            border-left-color: #cbd5e0;
            opacity: 0.7;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-active {
            background-color: #10b981;
            color: white;
        }

        .badge-inactive {
            background-color: #ef4444;
            color: white;
        }

        .badge-moderate {
            background-color: #f59e0b;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">ğŸ‘¥ ì‚¬ìš°íšŒ íšŒì› ê´€ë¦¬</h1>
                    <p class="text-blue-100 mt-2">íšŒì›ë³„ íšŒë¹„ ë‚©ë¶€ í˜„í™© ë° í†µê³„</p>
                </div>
                <div class="flex gap-4">
                    <a href="index.html" class="bg-white text-blue-600 hover:bg-blue-50 font-semibold py-2 px-4 rounded-lg shadow transition">
                        ğŸ  ëŒ€ì‹œë³´ë“œ
                    </a>
                    <a href="excel_loader.html" class="bg-blue-500 hover:bg-blue-400 text-white font-semibold py-2 px-4 rounded-lg shadow transition">
                        ğŸ“Š ë°ì´í„° ì—…ë¡œë“œ
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- ìš”ì•½ í†µê³„ -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“Š ì „ì²´ í˜„í™©</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì´ íšŒì› ìˆ˜</p>
                            <p class="text-3xl font-bold text-blue-600 mt-2" id="totalMembers">0</p>
                        </div>
                        <div class="text-4xl">ğŸ‘¥</div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">í™œë™ íšŒì›</p>
                            <p class="text-3xl font-bold text-green-600 mt-2" id="activeMembers">0</p>
                        </div>
                        <div class="text-4xl">âœ…</div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">ì´ íšŒë¹„ ë‚©ë¶€ì•¡</p>
                            <p class="text-3xl font-bold text-purple-600 mt-2" id="totalContributions">â‚©0</p>
                        </div>
                        <div class="text-4xl">ğŸ’°</div>
                    </div>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-medium">í‰ê·  ë‚©ë¶€ì•¡</p>
                            <p class="text-3xl font-bold text-orange-600 mt-2" id="avgContribution">â‚©0</p>
                        </div>
                        <div class="text-4xl">ğŸ“ˆ</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
        <section class="mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ˆ íšŒì› ë¶„ì„</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">íšŒì›ë³„ ë‚©ë¶€ì•¡ ë¹„êµ</h3>
                    <canvas id="memberContributionChart"></canvas>
                </div>

                <div class="card bg-white rounded-xl shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ë‚©ë¶€ ê±´ìˆ˜ ë¹„êµ</h3>
                    <canvas id="memberCountChart"></canvas>
                </div>
            </div>
        </section>

        <!-- íšŒì› ëª©ë¡ -->
        <section class="mb-8">
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ‘¤ íšŒì›ë³„ ìƒì„¸ ë‚´ì—­</h2>

                    <!-- í•„í„° -->
                    <div class="flex gap-4 mb-4">
                        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="all">ì „ì²´</option>
                            <option value="active">í™œë™ íšŒì›</option>
                            <option value="inactive">ë¹„í™œë™ íšŒì›</option>
                        </select>

                        <select id="sortOrder" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="amount_desc">ë‚©ë¶€ì•¡ ë†’ì€ìˆœ</option>
                            <option value="amount_asc">ë‚©ë¶€ì•¡ ë‚®ì€ìˆœ</option>
                            <option value="count_desc">ë‚©ë¶€ ê±´ìˆ˜ ë§ì€ìˆœ</option>
                            <option value="date_desc">ìµœê·¼ ë‚©ë¶€ìˆœ</option>
                            <option value="name">ì´ë¦„ìˆœ</option>
                        </select>
                    </div>
                </div>

                <!-- íšŒì› ì¹´ë“œ ëª©ë¡ -->
                <div id="membersList" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- íšŒì› ì¹´ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400">Â© 2025 ì‚¬ìš°íšŒ íšŒë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
            <p class="text-gray-500 text-sm mt-2">ë°ì´í„° ì—…ë°ì´íŠ¸: <span id="last-update">-</span></p>
        </div>
    </footer>

    <script>
        let memberData = null;
        let allMembers = [];

        // ë°ì´í„° ë¡œë“œ
        async function loadData() {
            try {
                // localStorageì—ì„œ í–¥ìƒëœ ë°ì´í„° í™•ì¸
                const savedData = localStorage.getItem('enhanced_dashboard_data');
                if (savedData) {
                    console.log('localStorageì—ì„œ í–¥ìƒëœ ë°ì´í„° ë¡œë“œ');
                    memberData = JSON.parse(savedData);
                } else {
                    // enhanced_dashboard_data.json íŒŒì¼ì—ì„œ ë¡œë“œ
                    console.log('JSON íŒŒì¼ì—ì„œ ë°ì´í„° ë¡œë“œ');
                    const response = await fetch('enhanced_dashboard_data.json');
                    memberData = await response.json();
                }

                initializePage();
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showError();
            }
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        function initializePage() {
            if (!memberData || !memberData.member_analysis) {
                showError();
                return;
            }

            // íšŒì› ë°ì´í„° ì²˜ë¦¬
            allMembers = Object.entries(memberData.member_analysis).map(([name, info]) => ({
                name,
                ...info,
                status: getMíšŒì›Status(info)
            }));

            // ëª¨ë“  ì•Œë ¤ì§„ íšŒì› í¬í•¨ (ë‚©ë¶€ ì´ë ¥ì´ ì—†ì–´ë„)
            const knownMembers = memberData.known_members || [];
            knownMembers.forEach(name => {
                if (!allMembers.find(m => m.name === name)) {
                    allMembers.push({
                        name,
                        total_paid: 0,
                        payment_count: 0,
                        payments: [],
                        last_payment_date: null,
                        average_amount: 0,
                        status: 'inactive'
                    });
                }
            });

            updateSummary();
            updateCharts();
            renderMembersList();
            updateLastUpdate();
        }

        // íšŒì› ìƒíƒœ íŒë‹¨
        function getMemberStatus(info) {
            if (info.payment_count === 0) return 'inactive';
            if (info.payment_count >= 10) return 'active';
            return 'moderate';
        }

        // ìš”ì•½ í†µê³„ ì—…ë°ì´íŠ¸
        function updateSummary() {
            const totalMembers = allMembers.length;
            const activeMembers = allMembers.filter(m => m.status === 'active').length;
            const totalContributions = allMembers.reduce((sum, m) => sum + m.total_paid, 0);
            const avgContribution = totalContributions / Math.max(totalMembers, 1);

            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('activeMembers').textContent = activeMembers;
            document.getElementById('totalContributions').textContent = formatCurrency(totalContributions);
            document.getElementById('avgContribution').textContent = formatCurrency(avgContribution);
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateCharts() {
            createMemberContributionChart();
            createMemberCountChart();
        }

        // íšŒì›ë³„ ë‚©ë¶€ì•¡ ì°¨íŠ¸
        function createMemberContributionChart() {
            const sortedMembers = [...allMembers]
                .filter(m => m.total_paid > 0)
                .sort((a, b) => b.total_paid - a.total_paid)
                .slice(0, 10);

            const ctx = document.getElementById('memberContributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMembers.map(m => m.name),
                    datasets: [{
                        label: 'ì´ ë‚©ë¶€ì•¡ (ì›)',
                        data: sortedMembers.map(m => m.total_paid),
                        backgroundColor: 'rgba(0, 112, 192, 0.7)',
                        borderColor: 'rgb(0, 112, 192)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚©' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    }
                }
            });
        }

        // íšŒì›ë³„ ë‚©ë¶€ ê±´ìˆ˜ ì°¨íŠ¸
        function createMemberCountChart() {
            const sortedMembers = [...allMembers]
                .filter(m => m.payment_count > 0)
                .sort((a, b) => b.payment_count - a.payment_count)
                .slice(0, 10);

            const ctx = document.getElementById('memberCountChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMembers.map(m => m.name),
                    datasets: [{
                        label: 'ë‚©ë¶€ ê±´ìˆ˜',
                        data: sortedMembers.map(m => m.payment_count),
                        backgroundColor: 'rgba(16, 185, 129, 0.7)',
                        borderColor: 'rgb(16, 185, 129)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // íšŒì› ëª©ë¡ ë Œë”ë§
        function renderMembersList() {
            const container = document.getElementById('membersList');
            const statusFilter = document.getElementById('statusFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;

            // í•„í„°ë§
            let filteredMembers = [...allMembers];
            if (statusFilter !== 'all') {
                filteredMembers = filteredMembers.filter(m => m.status === statusFilter);
            }

            // ì •ë ¬
            switch(sortOrder) {
                case 'amount_desc':
                    filteredMembers.sort((a, b) => b.total_paid - a.total_paid);
                    break;
                case 'amount_asc':
                    filteredMembers.sort((a, b) => a.total_paid - b.total_paid);
                    break;
                case 'count_desc':
                    filteredMembers.sort((a, b) => b.payment_count - a.payment_count);
                    break;
                case 'date_desc':
                    filteredMembers.sort((a, b) => {
                        if (!a.last_payment_date) return 1;
                        if (!b.last_payment_date) return -1;
                        return b.last_payment_date.localeCompare(a.last_payment_date);
                    });
                    break;
                case 'name':
                    filteredMembers.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }

            // ë Œë”ë§
            container.innerHTML = '';

            if (filteredMembers.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-8">
                        í•´ë‹¹í•˜ëŠ” íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
                return;
            }

            filteredMembers.forEach(member => {
                const card = createMemberCard(member);
                container.appendChild(card);
            });
        }

        // íšŒì› ì¹´ë“œ ìƒì„±
        function createMemberCard(member) {
            const div = document.createElement('div');
            div.className = `member-card card bg-white rounded-lg shadow-md p-5 ${member.status === 'inactive' ? 'inactive' : ''}`;

            const statusBadge = member.status === 'active' ? 'badge-active' :
                               member.status === 'moderate' ? 'badge-moderate' : 'badge-inactive';
            const statusText = member.status === 'active' ? 'í™œë™' :
                              member.status === 'moderate' ? 'ë³´í†µ' : 'ë¹„í™œë™';

            div.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-xl font-bold text-gray-800">${member.name}</h3>
                    <span class="badge ${statusBadge}">${statusText}</span>
                </div>

                <div class="space-y-2 mb-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">ì´ ë‚©ë¶€ì•¡</span>
                        <span class="font-semibold text-blue-600">${formatCurrency(member.total_paid)}</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">ë‚©ë¶€ ê±´ìˆ˜</span>
                        <span class="font-semibold text-gray-800">${member.payment_count}ê±´</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">í‰ê·  ê¸ˆì•¡</span>
                        <span class="font-semibold text-gray-800">${formatCurrency(member.average_amount)}</span>
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">ìµœê·¼ ë‚©ë¶€</span>
                        <span class="font-semibold text-gray-800">${member.last_payment_date || '-'}</span>
                    </div>
                </div>

                ${member.payments && member.payments.length > 0 ? `
                    <details class="mt-4">
                        <summary class="cursor-pointer text-sm text-blue-600 hover:text-blue-800 font-medium">
                            ë‚©ë¶€ ì´ë ¥ ë³´ê¸° (${member.payments.length}ê±´)
                        </summary>
                        <div class="mt-3 space-y-2 max-h-40 overflow-y-auto">
                            ${member.payments.slice().reverse().slice(0, 5).map(p => `
                                <div class="text-xs bg-gray-50 p-2 rounded">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">${p.date}</span>
                                        <span class="font-semibold text-green-600">${formatCurrency(p.amount)}</span>
                                    </div>
                                </div>
                            `).join('')}
                            ${member.payments.length > 5 ? `<div class="text-xs text-gray-500 text-center">... ì™¸ ${member.payments.length - 5}ê±´</div>` : ''}
                        </div>
                    </details>
                ` : ''}
            `;

            return div;
        }

        // ê¸ˆì•¡ í¬ë§·
        function formatCurrency(amount) {
            return 'â‚©' + Math.round(amount).toLocaleString('ko-KR');
        }

        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
        function updateLastUpdate() {
            const timestamp = memberData.enhanced_processing_date || memberData.last_updated;
            document.getElementById('last-update').textContent = timestamp || '-';
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError() {
            const main = document.querySelector('main');
            main.innerHTML = `
                <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 rounded-lg shadow-md">
                    <div class="flex items-center mb-4">
                        <svg class="h-8 w-8 text-yellow-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <h2 class="text-2xl font-bold text-yellow-800">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
                    </div>
                    <p class="text-yellow-700 mb-4">í–¥ìƒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. Python ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ê±°ë‚˜ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
                    <div class="flex gap-4">
                        <a href="excel_loader.html" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                            ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œí•˜ê¸° â†’
                        </a>
                        <a href="index.html" class="inline-block bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow transition">
                            ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                        </a>
                    </div>
                </div>
            `;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            // í•„í„° ë° ì •ë ¬ ì´ë²¤íŠ¸
            document.getElementById('statusFilter')?.addEventListener('change', renderMembersList);
            document.getElementById('sortOrder')?.addEventListener('change', renderMembersList);
        });
    </script>
</body>
</html>
